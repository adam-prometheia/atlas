{% extends "layout.html" %}

{% block content %}
<div class="section-header">
    <div>
        <h1>{{ contact.name }}</h1>
        <div class="help-text">{{ contact.role }} Â· {{ contact.company_name }}</div>
    </div>
    <div class="action-stack">
        <div class="action-row">
            <button type="button" class="button" onclick="draftEmail('draft_first_email')">Draft First Email</button>
            <button type="button" class="button" onclick="draftEmail('draft_followup')">Draft Follow-up Email</button>
            <a class="button" href="/contacts/{{ contact.id }}/draft_custom_email">Draft Custom Email</a>
        </div>
        <div class="action-row secondary">
            <a class="button secondary" href="/contacts/{{ contact.id }}/edit">Edit Contact</a>
            <a class="button secondary" href="/contacts/{{ contact.id }}/interactions/new">Log Interaction</a>
            <a class="button secondary" href="/contacts/{{ contact.id }}/notes/new">Add Note</a>
        </div>
    </div>
</div>

<div style="margin-top: 1.5rem;">
    <div><strong>Email:</strong> <a href="mailto:{{ contact.email }}">{{ contact.email }}</a></div>
    {% if contact.linkedin_url %}
    <div><strong>LinkedIn:</strong> <a href="{{ contact.linkedin_url }}" target="_blank">{{ contact.linkedin_url }}</a></div>
    {% endif %}
    {% if contact.website_url %}
    <div><strong>Website:</strong> <a href="{{ contact.website_url }}" target="_blank">{{ contact.website_url }}</a></div>
    {% endif %}
    <div><strong>Source:</strong> {{ contact.source | replace("_", " ") | title }}</div>
    <div><strong>Status:</strong> {{ contact.status | replace("_", " ") | title }}</div>
    <div><strong>Created:</strong> {{ contact.created_at.strftime("%Y-%m-%d %H:%M") if contact.created_at else "-" }}</div>
    <div><strong>Updated:</strong> {{ contact.updated_at.strftime("%Y-%m-%d %H:%M") if contact.updated_at else "-" }}</div>
</div>

{% if suggestions_enabled %}
<div class="section-header" style="margin-top: 1.5rem;">
    <h2>Next Action Assistant</h2>
    <span></span>
</div>
<div class="card" style="padding: 1rem;">
    <div id="suggestion-error" class="alert" style="display: none; margin-bottom: 0.75rem;">
        <span id="suggestion-error-message"></span>
        <button type="button" class="button secondary" id="suggestion-retry" style="margin-left: 0.5rem;">Retry</button>
    </div>
    <div class="action-row" style="gap: 0.75rem; align-items: center; flex-wrap: wrap;">
        <button type="button" class="button" id="suggest-next-action">Suggest Next Action</button>
        <button type="button" class="button secondary" id="apply-suggestion" disabled>Create Next Action from suggestion</button>
        <span id="suggestion-status" class="help-text"></span>
    </div>
    <div id="next-action-suggestion" style="display: none; margin-top: 1rem;">
        <p><strong>Type:</strong> <span id="suggestion-type">-</span></p>
        <p><strong>Title:</strong> <span id="suggestion-title">-</span></p>
        <p><strong>Description:</strong> <span id="suggestion-description">-</span></p>
        <p><strong>Suggested due date:</strong> <span id="suggestion-due-date">-</span></p>
        <p><strong>Confidence:</strong> <span id="suggestion-confidence">-</span></p>
        <p><strong>Notes for Adam:</strong></p>
        <div id="suggestion-notes" class="preformatted" style="white-space: pre-wrap; margin-bottom: 1rem;">-</div>
        <div style="margin-bottom: 0.5rem;">
            <label for="suggestion-email-subject"><strong>Proposed subject</strong></label>
            <input type="text" id="suggestion-email-subject" style="width: 100%; margin-top: 0.25rem;" readonly>
        </div>
        <div style="margin-bottom: 0.75rem;">
            <label for="suggestion-email-body"><strong>Proposed email draft</strong></label>
            <textarea id="suggestion-email-body" style="width: 100%; height: 160px; margin-top: 0.25rem;" readonly></textarea>
        </div>
        <div class="action-row" style="gap: 0.5rem; flex-wrap: wrap;">
            <a class="button secondary" href="/contacts/{{ contact.id }}/interactions/new">Log your own next action</a>
            <button type="button" class="button secondary" id="copy-suggestion-email">Copy email draft</button>
        </div>
    </div>
</div>
{% endif %}

<div class="draft-output" id="draft-output-container" style="display: none;">
    <p id="draft-status" class="help-text"></p>
    <textarea id="draft-output" style="width: 100%; height: 220px;"></textarea>
</div>
<p id="draft-status-inline" class="empty" style="display: none; margin-top: 1rem;"></p>

<div class="section-header">
    <h2>Interactions</h2>
    <span></span>
</div>
{% if contact.interactions %}
<table>
    <thead>
        <tr>
            <th>When</th>
            <th>Type</th>
            <th>Summary</th>
            <th>Next Action</th>
            <th>Due</th>
            <th>Outcome</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for interaction in contact.interactions %}
        <tr>
            <td>{{ interaction.timestamp.strftime("%Y-%m-%d %H:%M") if interaction.timestamp else "-" }}</td>
            <td>{{ interaction.type | replace("_", " ") | title }}</td>
            <td><div class="preformatted interaction-summary">{{ interaction.summary }}</div></td>
            <td>{{ interaction.next_action or "-" }}</td>
            <td>{{ interaction.next_action_due.strftime("%Y-%m-%d") if interaction.next_action_due else "-" }}</td>
            <td>
                {{ interaction.outcome.replace("_", " ") | title }}
                {% if interaction.outcome_notes %}
                    <div class="help-text">{{ interaction.outcome_notes }}</div>
                {% endif %}
            </td>
            <td>
                <div class="action-row" style="gap: 0.35rem; flex-wrap: wrap;">
                    <a class="button secondary" href="/interactions/{{ interaction.id }}/edit">Edit</a>
                    <form method="post" action="/interactions/{{ interaction.id }}/delete" style="margin: 0;">
                        <button type="submit" class="button secondary">Delete</button>
                    </form>
                </div>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
    <p class="empty">No interactions logged yet.</p>
{% endif %}

<div class="section-header">
    <h2>Notes</h2>
    <div class="toggle-group" role="group">
        <button type="button" data-mode="raw">Raw</button>
        <button type="button" data-mode="structured">Structured</button>
    </div>
</div>
{% if contact.notes %}
<table id="notes-table">
    <thead>
        <tr>
            <th>Date</th>
            <th class="note-raw-header">Raw Notes</th>
            <th class="note-structured-header">Structured Summary</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
    {% for note in contact.notes %}
        {% set summary = (note.processed_summary or "").strip() %}
        {% set has_structured = summary and summary != "-" %}
        <tr data-note-id="{{ note.id }}">
            <td>{{ note.meeting_date.strftime("%Y-%m-%d") if note.meeting_date else "-" }}</td>
            <td class="note-raw">
                <div class="preformatted">{{ note.raw_notes }}</div>
            </td>
            <td class="note-structured" data-has-content="{{ 'true' if has_structured else 'false' }}">
                {% if has_structured %}
                    <div class="preformatted">{{ note.processed_summary }}</div>
                {% else %}
                    <div class="empty">No structured summary yet.</div>
                {% endif %}
            </td>
            <td>
                <div class="action-stack" style="margin-top: 0;">
                    <div class="action-row" style="gap: 0.35rem; flex-wrap: wrap;">
                        <a class="button secondary" href="/notes/{{ note.id }}/edit">Edit</a>
                        <button type="button" class="button secondary" data-note-id="{{ note.id }}">
                            {% if has_structured %}Refresh structured summary{% else %}Generate structured summary{% endif %}
                        </button>
                        <form method="post" action="/notes/{{ note.id }}/delete" style="margin: 0;">
                            <button type="submit" class="button secondary">Delete</button>
                        </form>
                    </div>
                    <div class="help-text note-status" style="display: none;"></div>
                </div>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
    <p class="empty">No notes recorded yet.</p>
{% endif %}

<script>
    const rawToggle = document.querySelector('.toggle-group button[data-mode="raw"]');
    const structuredToggle = document.querySelector('.toggle-group button[data-mode="structured"]');
    const notesTable = document.getElementById('notes-table');
    const suggestionButton = document.getElementById('suggest-next-action');
    const suggestionStatus = document.getElementById('suggestion-status');
    const suggestionContainer = document.getElementById('next-action-suggestion');
    const copySuggestionButton = document.getElementById('copy-suggestion-email');
    const suggestionError = document.getElementById('suggestion-error');
    const suggestionErrorMessage = document.getElementById('suggestion-error-message');
    const suggestionRetryButton = document.getElementById('suggestion-retry');
    const applySuggestionButton = document.getElementById('apply-suggestion');
    const suggestionFields = {
        type: document.getElementById('suggestion-type'),
        title: document.getElementById('suggestion-title'),
        description: document.getElementById('suggestion-description'),
        dueDate: document.getElementById('suggestion-due-date'),
        confidence: document.getElementById('suggestion-confidence'),
        notes: document.getElementById('suggestion-notes'),
        emailSubject: document.getElementById('suggestion-email-subject'),
        emailBody: document.getElementById('suggestion-email-body'),
    };
    let currentNotesMode = 'raw';
    let lastSuggestionData = null;

    function setNotesView(mode) {
        currentNotesMode = mode;
        const showStructured = mode === 'structured';
        document.querySelectorAll('.note-raw').forEach((cell) => {
            cell.toggleAttribute('hidden', showStructured);
        });
        document.querySelectorAll('.note-structured').forEach((cell) => {
            cell.toggleAttribute('hidden', !showStructured);
        });
        const rawHeader = document.querySelector('.note-raw-header');
        const structuredHeader = document.querySelector('.note-structured-header');
        if (rawHeader) rawHeader.toggleAttribute('hidden', showStructured);
        if (structuredHeader) structuredHeader.toggleAttribute('hidden', !showStructured);
        if (rawToggle) {
            rawToggle.classList.toggle('active', mode === 'raw');
        }
        if (structuredToggle) {
            structuredToggle.classList.toggle('active', mode === 'structured');
        }
    }

    function determineInitialNotesMode() {
        if (!notesTable) {
            return 'raw';
        }
        const anyStructured = Array.from(notesTable.querySelectorAll('.note-structured'))
            .some((cell) => cell.dataset.hasContent === 'true');
        return anyStructured ? 'structured' : 'raw';
    }

    async function draftEmail(endpoint) {
        const statusInline = document.getElementById('draft-status-inline');
        const container = document.getElementById('draft-output-container');
        const textarea = document.getElementById('draft-output');
        const statusText = document.getElementById('draft-status');

        statusInline.style.display = 'none';
        container.style.display = 'block';
        statusText.textContent = 'Generating email draft...';

        try {
            const response = await fetch(`/contacts/{{ contact.id }}/${endpoint}`, { method: 'POST' });
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}`);
            }
            const data = await response.json();
            textarea.value = data.email || '';
            statusText.textContent = 'Draft ready below. Edit freely before sending.';
        } catch (error) {
            container.style.display = 'none';
            statusInline.style.display = 'block';
            statusInline.textContent = `Unable to generate draft: ${error.message}`;
        }
    }

    async function summariseNote(noteId) {
        const row = document.querySelector(`[data-note-id="${noteId}"]`);
        if (!row) return;
        const statusEl = row.querySelector('.note-status');
        const structuredCell = row.querySelector('.note-structured');
        const button = row.querySelector('button[data-note-id]');

        if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.textContent = 'Generating structured summary...';
        }
        if (button) {
            button.disabled = true;
        }

        try {
            const response = await fetch(`/notes/${noteId}/summarise`, { method: 'POST' });
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}`);
            }
            const data = await response.json();
            const summary = data.summary || '';
            structuredCell.dataset.hasContent = summary.trim() ? 'true' : 'false';
            if (summary.trim()) {
                const container = document.createElement('div');
                container.className = 'preformatted';
                container.textContent = summary;
                structuredCell.innerHTML = '';
                structuredCell.appendChild(container);
                if (button) {
                    button.textContent = 'Refresh structured summary';
                }
            } else {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty';
                emptyDiv.textContent = 'No structured summary yet.';
                structuredCell.innerHTML = '';
                structuredCell.appendChild(emptyDiv);
                if (button) {
                    button.textContent = 'Generate structured summary';
                }
            }
            if (statusEl) {
                statusEl.textContent = 'Updated.';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 2500);
            }
            setNotesView(currentNotesMode);
        } catch (error) {
            if (statusEl) {
                statusEl.textContent = `Unable to summarise: ${error.message}`;
            }
        } finally {
            if (button) {
                button.disabled = false;
            }
        }
    }

    async function requestNextActionSuggestion() {
        if (!suggestionButton || !suggestionStatus) {
            return;
        }
        suggestionButton.disabled = true;
        suggestionStatus.textContent = 'Gathering signals...';
        if (suggestionError) {
            suggestionError.style.display = 'none';
        }
        try {
            const response = await fetch(`/contacts/{{ contact.id }}/suggest_next_action`);
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}`);
            }
            const data = await response.json();
            populateSuggestion(data);
            suggestionStatus.textContent = 'Suggestion ready. Review before using.';
        } catch (error) {
            suggestionStatus.textContent = `Unable to fetch suggestion: ${error.message}`;
            if (suggestionError && suggestionErrorMessage) {
                suggestionErrorMessage.textContent = `We couldn't load a suggestion (${error.message}).`;
                suggestionError.style.display = 'flex';
            }
        } finally {
            if (suggestionButton) {
                suggestionButton.disabled = false;
            }
        }
    }

    function populateSuggestion(data) {
        if (!suggestionFields.type) {
            return;
        }
        lastSuggestionData = data;
        const title = data.next_action_title || '';
        const description = data.next_action_description || '';
        const type = (data.next_action_type || 'no_action_recommended').replace(/_/g, ' ');
        const dueDate = data.suggested_due_date || '-';
        const confidence = typeof data.confidence === 'number'
            ? `${Math.round(data.confidence * 100)}%`
            : '-';
        suggestionFields.type.textContent = type;
        suggestionFields.title.textContent = title || '(no title suggested)';
        suggestionFields.description.textContent = description || '(no description provided)';
        suggestionFields.dueDate.textContent = dueDate;
        suggestionFields.confidence.textContent = confidence;
        suggestionFields.notes.textContent = data.notes_for_adam || '-';
        if (suggestionFields.emailSubject) {
            suggestionFields.emailSubject.value = data.proposed_email_subject || '';
        }
        if (suggestionFields.emailBody) {
            suggestionFields.emailBody.value = data.proposed_email_body || '';
        }
        if (applySuggestionButton) {
            const disableApply = !data || data.next_action_type === 'no_action_recommended';
            applySuggestionButton.disabled = disableApply;
        }
        if (suggestionContainer) {
            suggestionContainer.style.display = 'block';
        }
    }

    async function copySuggestedEmail() {
        if (!suggestionFields.emailBody || !suggestionFields.emailBody.value) {
            suggestionStatus.textContent = 'No draft to copy yet.';
            return;
        }
        try {
            await navigator.clipboard.writeText(suggestionFields.emailBody.value);
            suggestionStatus.textContent = 'Email draft copied.';
        } catch (error) {
            suggestionStatus.textContent = 'Unable to copy draft.';
        }
    }

    async function applySuggestedNextAction() {
        if (!applySuggestionButton || !lastSuggestionData) {
            suggestionStatus.textContent = 'No suggestion to apply yet.';
            return;
        }
        if (lastSuggestionData.next_action_type === 'no_action_recommended') {
            suggestionStatus.textContent = 'Current suggestion does not include an actionable next step.';
            return;
        }
        applySuggestionButton.disabled = true;
        suggestionStatus.textContent = 'Creating next action...';
        try {
            const response = await fetch(`/contacts/{{ contact.id }}/apply_suggested_next_action`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lastSuggestionData),
            });
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}`);
            }
            suggestionStatus.textContent = 'Next action created. You can refine it in the interactions list.';
        } catch (error) {
            suggestionStatus.textContent = `Unable to apply suggestion: ${error.message}`;
        } finally {
            if (applySuggestionButton) {
                applySuggestionButton.disabled = lastSuggestionData.next_action_type === 'no_action_recommended';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const initialMode = determineInitialNotesMode();
        setNotesView(initialMode);

        // attach click handlers for note summarise buttons that carry data-note-id
        document.querySelectorAll('button[data-note-id]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const id = btn.dataset.noteId;
                if (id) summariseNote(id);
            });
        });

        if (suggestionButton) {
            suggestionButton.addEventListener('click', requestNextActionSuggestion);
        }
        if (copySuggestionButton) {
            copySuggestionButton.addEventListener('click', copySuggestedEmail);
        }
        if (applySuggestionButton) {
            applySuggestionButton.addEventListener('click', applySuggestedNextAction);
        }
        if (suggestionRetryButton) {
            suggestionRetryButton.addEventListener('click', (event) => {
                event.preventDefault();
                requestNextActionSuggestion();
            });
        }
    });

    if (rawToggle) {
        rawToggle.addEventListener('click', () => setNotesView('raw'));
    }
    if (structuredToggle) {
        structuredToggle.addEventListener('click', () => setNotesView('structured'));
    }
</script>
{% endblock %}
